<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Invio diretto a parlamentari</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div id="header"></div>

  <main class="container">
    <div class="page-intro">
      <h1>Invia un'email ai parlamentari italiani</h1>
      <p>Premi i pulsanti qui sotto per aprire il tuo programma di posta con i destinatari già compilati.</p>
    </div>

    <table>
      <thead>
        <tr>
          <th>Cargo</th>
          <th>Total</th>
          <th>Azione</th>
        </tr>
      </thead>
      <tbody id="tabela-parlamentares">
        <!-- Preenchido via JS -->
      </tbody>
    </table>
  </main>

  <div id="footer"></div>

  <script>
    const titulos = [
      "Difendiamo la cittadinanza italiana per discendenza",
      "Appello contro il Decreto-Legge 36/2025",
      "Tutela dei diritti dei cittadini italo-discendenti",
      "Preservare l’identità italiana oltre i confini",
      "No alla stretta sulla cittadinanza agli italiani all’estero"
    ];

    async function sortearMensagem() {
      const res = await fetch('mensagens.json');
      const mensagens = await res.json();
      const escolhida = mensagens[Math.floor(Math.random() * mensagens.length)];
      return escolhida.it;
    }

    async function dividirEmails(tipo, maxPorGrupo = 135) {
      const res = await fetch(`${tipo}.json`);
      const parlamentares = await res.json();
      const grupos = [];
      for (let i = 0; i < parlamentares.length; i += maxPorGrupo) {
        const grupo = parlamentares.slice(i, i + maxPorGrupo);
        grupos.push(grupo.map(p => p.email).join(','));
      }
      return grupos;
    }

    async function gerarBotoes(tipo, nomeCargo, containerId) {
      const corpo = encodeURIComponent(await sortearMensagem());
      const assunto = encodeURIComponent(titulos[Math.floor(Math.random() * titulos.length)]);
      const grupos = await dividirEmails(tipo);

      const tbody = document.getElementById(containerId);
      const tr = document.createElement('tr');

      const tdCargo = document.createElement('td');
      tdCargo.textContent = nomeCargo;
      tr.appendChild(tdCargo);

      const tdTotal = document.createElement('td');
      tdTotal.textContent = grupos.reduce((acc, grupo) => acc + grupo.split(',').length, 0);
      tr.appendChild(tdTotal);

      const tdAcoes = document.createElement('td');
      grupos.forEach((grupo, index) => {
        const botao = document.createElement('button');
        botao.textContent = `Email ${index + 1} di ${grupos.length}`;
        botao.onclick = () => {
          const mailto = `mailto:${grupo}?subject=${assunto}&body=${corpo}`;
          window.location.href = mailto;
        };
        tdAcoes.appendChild(botao);
      });

      tr.appendChild(tdAcoes);
      tbody.appendChild(tr);
    }

    async function inicializar() {
      await gerarBotoes('deputados', 'Deputati', 'tabela-parlamentares');
      await gerarBotoes('senadores', 'Senatori', 'tabela-parlamentares');
    }

    document.addEventListener('DOMContentLoaded', inicializar);

    // Carregar header e footer externos (opcional)
    fetch('header.html')
      .then(res => res.text())
      .then(data => document.getElementById('header').innerHTML = data);

    fetch('footer.html')
      .then(res => res.text())
      .then(data => document.getElementById('footer').innerHTML = data);
  </script>
</body>
</html>
